# Техническое задание: API для извлечения текста для RAG

**Версия:** 1.8.0
**Дата:** 06.07.2025
**Заказчик:** ООО "СОФТОНИТ"

---

### 1. Общие сведения

**1.1. Назначение системы:**
Разработка серверного API (далее — Сервис) для комплексного извлечения текстового содержимого из файлов различных форматов.

**1.2. Конечная цель и контекст использования:**
Извлеченный текст будет использоваться для создания векторных представлений (embeddings) с последующей загрузкой в векторную базу данных в рамках системы **RAG (Retrieval-Augmented Generation)**.
Ключевыми приоритетами являются **полнота, точность и структурированность** извлекаемых данных для обеспечения максимального качества работы RAG-модели.

### 2. Термины и определения

* **RAG (Retrieval-Augmented Generation):** Архитектура, объединяющая языковые модели с внешними базами знаний для повышения точности и релевантности ответов.
* **OCR (Optical Character Recognition):** Оптическое распознавание символов; технология преобразования изображений с текстом в машиночитаемый текст.
* **API (Application Programming Interface):** Программный интерфейс приложения.

### 3. Функциональные требования

**3.1. Общая стратегия извлечения:**
Сервис должен извлекать **весь доступный текстовый контент** из файла, объединяя данные из разных источников (текстовый слой, OCR, метаданные) в единый вывод.

**3.2. Обработка PDF-документов:**
1. Извлекается основной текстовый слой документа.
2. Из документа извлекаются все встроенные изображения.
3. К каждому изображению применяется процедура OCR (согласно п. 3.4).
4. Текст, полученный после OCR, объединяется с текстом из основного слоя.  Рекомендуемая структура итогового текста для сохранения семантической связности:
```
[Текст со страницы 1]
--- OCR ---
[Текст с первого изображения на странице 1]
[Текст со второго изображения на странице 1]
---
[Текст со страницы 2]
...
```

**3.3. Обработка документов (`.doc`, `.docx`, `.odt`, `.rtf`) и презентаций (`.pptx`, `.ppt`):**
* Извлекается текст из основного тела документа, а также из **колонтитулов, сносок, комментариев и заметок спикера**.
* К встроенным изображениям применяется процедура OCR.
* Для `.doc` файлов (старый формат Microsoft Word) используется конвертация в `.docx` через LibreOffice в headless режиме для максимальной совместимости.
* Для `.ppt` файлов (старый формат Microsoft PowerPoint) используется конвертация в `.pptx` через LibreOffice в headless режиме для максимальной совместимости.

**3.4. Обработка изображений и OCR:**
* **Поддерживаемые форматы:** `.jpg`, `.jpeg`, `.png`, `.tiff`, `.tif`, `.bmp`, `.gif`.
* **Языки:** Сервис должен по умолчанию производить распознавание одновременно на **русском и английском языках**.
* **Отсутствие текста:** Если OCR-движок не обнаруживает текст на изображении, оно игнорируется.

**3.5. Обработка таблиц (`.xls`, `.xlsx`, `.csv`, `.ods`):**
* Данные из таблиц должны быть преобразованы в формат **CSV (Comma-Separated Values)**.
* Каждый лист таблицы конвертируется в отдельный блок, разделенный маркером.

**3.6. Обработка структурированных данных (`.xml`, `.yaml`, `.yml`, `.json`):**
* **XML файлы:** Извлекается содержимое всех элементов, атрибутов и текстовых узлов с сохранением иерархической структуры.
* **YAML/YML файлы:** Рекурсивно извлекаются все ключи и значения из конфигурационных файлов с указанием путей.
* **JSON файлы:** Извлекаются все строковые значения с указанием их пути в структуре данных.

**3.7. Обработка электронных книг и писем (`.epub`, `.eml`, `.msg`):**
* **EPUB файлы:** Извлекается текстовое содержимое из всех HTML/XHTML файлов с применением защиты от zip-бомб (ограничение размера распакованного архива до 100 МБ).
* **EML файлы:** Извлекаются заголовки письма (From, To, Subject, Date) и текстовое содержимое тела письма (как plain text, так и HTML).
* **MSG файлы:** Применяется эвристический анализ для извлечения читаемого текста из формата Outlook.

**3.8. Обработка исходного кода:**
* **Поддерживаемые языки программирования:** Python (`.py`, `.pyx`, `.pyi`, `.pyw`), JavaScript/TypeScript (`.js`, `.jsx`, `.ts`, `.tsx`, `.mjs`, `.cjs`), Java (`.java`, `.jav`), C/C++ (`.c`, `.cpp`, `.cxx`, `.cc`, `.c++`, `.h`, `.hpp`, `.hxx`, `.h++`), C# (`.cs`, `.csx`), PHP (`.php`, `.php3`, `.php4`, `.php5`, `.phtml`), Ruby (`.rb`, `.rbw`, `.rake`, `.gemspec`), Go (`.go`, `.mod`, `.sum`), Rust (`.rs`, `.rlib`), Swift (`.swift`), Kotlin (`.kt`, `.kts`), Scala (`.scala`, `.sc`), R (`.r`, `.R`, `.rmd`, `.Rmd`), SQL (`.sql`, `.ddl`, `.dml`), Shell (`.sh`, `.bash`, `.zsh`, `.fish`, `.ksh`, `.csh`, `.tcsh`), PowerShell (`.ps1`, `.psm1`, `.psd1`), Perl (`.pl`, `.pm`, `.pod`, `.t`), Lua (`.lua`), **1C:Enterprise (`.bsl`)**, **OneScript (`.os`)**, **Российские платформы разработки:** Специальная поддержка для файлов 1С:Предприятие и OneScript - популярных инструментов в российской IT-индустрии
* **Конфигурационные файлы:** INI (`.ini`), конфигурационные файлы (`.cfg`, `.conf`, `.config`), TOML (`.toml`), Properties (`.properties`)
* **Веб-технологии:** CSS (`.css`, `.scss`, `.sass`, `.less`, `.styl`)
* **Разметка и документация:** LaTeX (`.tex`, `.latex`), reStructuredText (`.rst`), AsciiDoc (`.adoc`, `.asciidoc`)
* **Специальные форматы:** JSON Lines (`.jsonl`, `.ndjson`), JSON с комментариями (`.jsonc`), Docker (`.dockerfile`, `.containerfile`), Makefile (`.makefile`, `.mk`, `.mak`), Git (`.gitignore`, `.gitattributes`, `.gitmodules`)
* **Обработка:** Файлы исходного кода обрабатываются с сохранением структуры и форматирования. Добавляется заголовок с указанием языка программирования, имени файла и количества строк для лучшего контекста при использовании в RAG-системах.

**3.9. Обработка архивов:**
* **Поддерживаемые форматы архивов:** `.zip`, `.rar`, `.7z`, `.tar`, `.gz`, `.bz2`, `.xz`, `.tgz`, `.tbz2`, `.txz`, `.tar.gz`, `.tar.bz2`, `.tar.xz`.
* **Стратегия обработки:** При обнаружении архивного файла система распаковывает его в отдельном процессе и обрабатывает каждый файл в архиве согласно его типу.
* **Безопасность:**
  * **Проверка размера архива:** Размер архива не должен превышать максимально допустимый размер файла (20 МБ).
  * **Защита от zip-бомб:** Максимальный размер распакованного содержимого ограничен 100 МБ.
  * **Защита от path traversal:** Имена файлов в архиве санитизируются для предотвращения атак типа directory traversal.
  * **Изоляция процесса:** Распаковка выполняется в отдельном процессе с таймаутом для предотвращения блокировки основного процесса.
  * **Контроль глубины вложенности:** Максимальная глубина вложенности архивов составляет 3 уровня.
* **Обработка файлов:** Каждый файл в архиве обрабатывается согласно его типу (документы, изображения, исходный код и т.д.).
* **Фильтрация файлов:** Игнорируются системные файлы (.DS_Store, Thumbs.db, .git/), временные файлы и папки.
* **Контроль временных файлов:** Все временные файлы и папки, созданные во время распаковки, автоматически удаляются после завершения обработки.

**3.10. Обработка прочих форматов (`.txt`, `.html`, `.md` и др.):**
* Извлекается текстовое содержимое. Из форматов с разметкой разметка удаляется.

### 4. Требования к API

**4.0. Базовый URL:**
* Для локальной разработки Сервис должен быть доступен по адресу `http://localhost:7555`.

**4.1. Эндпоинт `GET /` — Информация о API**
* **Ответ (`HTTP 200 OK`):**
```json
{
  "api_name": "Text Extraction API for RAG",
  "version": "1.8.0",
  "contact": "ООО 'СОФТОНИТ'"
}
```

**4.2. Эндпоинт `GET /health` — Проверка состояния**
* **Ответ (`HTTP 200 OK`):**
```json
{
  "status": "ok"
}
```

**4.3. Эндпоинт `GET /v1/supported-formats/` — Поддерживаемые форматы**
* **Ответ (`HTTP 200 OK`):**
```json
{
  "images_ocr": ["jpg", "jpeg", "png", "tiff", "tif", "bmp", "gif"],
  "documents": ["doc", "docx", "pdf", "rtf", "odt"],
  "spreadsheets": ["csv", "xls", "xlsx", "ods"],
  "presentations": ["pptx", "ppt"],
  "structured_data": ["json", "xml", "yaml", "yml"],
  "source_code": ["py", "js", "ts", "java", "c", "cpp", "h", "cs", "php", "rb", "go", "rs", "swift", "kt", "scala", "sql", "sh", "ps1", "pl", "lua", "bsl", "os", "ini", "css", "tex", "dockerfile", "makefile", "gitignore"],
  "other": ["txt", "html", "htm", "md", "markdown", "epub", "eml", "msg"],
  "archives": ["zip", "rar", "7z", "tar", "gz", "bz2", "xz", "tgz", "tbz2", "txz", "tar.gz", "tar.bz2", "tar.xz"]
}
```

**4.4. Эндпоинт `POST /v1/extract/` — Извлечение текста**
* **Метод:** `POST`.
* **Тело запроса:** `multipart/form-data` с полем `file`.
* **Успешный ответ (`HTTP 200 OK`):**
```json
{
  "status": "success",
  "filename": "invoice.pdf",
  "files": [
    {
      "filename": "invoice.pdf",
      "path": "invoice.pdf",
      "size": 1024000,
      "type": "pdf",
      "text": "Полностью извлеченный и скомбинированный текст..."
    }
  ]
}
```

* **Успешный ответ для архива (`HTTP 200 OK`):**
```json
{
  "status": "success",
  "filename": "documents.zip",
  "files": [
    {
      "filename": "document1.pdf",
      "path": "documents/document1.pdf",
      "size": 524288,
      "type": "pdf",
      "text": "Текст из первого документа..."
    },
    {
      "filename": "image1.jpg",
      "path": "documents/images/image1.jpg",
      "size": 102400,
      "type": "jpg",
      "text": "Распознанный текст с изображения..."
    }
  ]
}
```
* **Ответы с ошибкой:**
    * **`400 Bad Request`**: Отсутствует заголовок Content-Length или некорректный запрос.
    * **`413 Payload Too Large`**: Файл превышает максимальный размер.
    * **`415 Unsupported Media Type`**: Формат файла не поддерживается, обнаружен архив, или расширение файла не соответствует его содержимому.
    * **`422 Unprocessable Entity`**: Файл поврежден, пуст или защищен паролем.
    * **`504 Gateway Timeout`**: Обработка файла превысила установленный лимит времени.
    
    Примеры ответов с ошибкой:
```json
{
  "status": "error",
  "filename": "document.pdf",
  "message": "Отсутствует заголовок Content-Length. Пожалуйста, убедитесь, что размер файла указан в запросе."
}
```

```json
{
  "status": "error",
  "filename": "malicious.txt",
  "message": "Расширение файла не соответствует его содержимому. Возможная подделка типа файла."
}
```

```json
{
  "status": "error",
  "filename": "broken.docx",
  "message": "Файл поврежден или формат не поддерживается."
}
```



**4.5. Документация API (Swagger UI):**
* Сервис должен предоставлять интерактивную документацию API, автоматически генерируемую фреймворком FastAPI.
* Интерактивная документация должна быть доступна по адресу `http://localhost:7555/docs`.

### 5. Нефункциональные требования

**5.1. Производительность:**
* **Максимальный размер файла:** **20 МБ**.
* **Таймаут обработки:** **300 секунд (5 минут)**. При превышении — возврат ошибки `504 Gateway Timeout`.
* **Многопроцессорность:** Для максимальной производительности рекомендуется использовать несколько worker-процессов uvicorn. Количество процессов настраивается переменной окружения `WORKERS`. Общепринятая практика для продакшена — использовать формулу: 2 * (количество ядер CPU) + 1.

**5.2. Асинхронность и производительность:**
* **Неблокирующая обработка:** Все CPU-bound операции (OCR, парсинг PDF, конвертация документов, работа с архивами, обработка изображений) ОБЯЗАТЕЛЬНО должны выполняться в отдельном пуле потоков для предотвращения блокировки event loop.
* **Использование run_in_threadpool:** Для выполнения синхронных операций используется `fastapi.concurrency.run_in_threadpool` или аналогичные механизмы.
* **Стабильность API:** Сервер должен оставаться отзывчивым и способным обрабатывать новые запросы даже во время обработки больших или сложных файлов.
* **Изоляция операций:** Каждая операция извлечения текста должна быть полностью изолирована, чтобы сбой в одной операции не влиял на другие.

**5.3. Безопасность:**
* Аутентификация не требуется (предназначено для внутренней сети).
* **Санитизация имен файлов:** Система должна очищать имена файлов от потенциально опасных символов и путей (например, `../`, `./`, специальные символы) для предотвращения атак типа path traversal. Используется библиотека `werkzeug.utils.secure_filename` или аналогичные методы санитизации.
* **Проверка MIME-типов:** Система проверяет соответствие содержимого файла заявленному расширению для предотвращения атак через подделку типа файла. При несоответствии расширения файла и его реального MIME-типа система логирует предупреждение и отклоняет файл с кодом ошибки `415 Unsupported Media Type`.
* **Защита от DoS-атак:** Система обязательно проверяет наличие заголовка `Content-Length` в запросе. Если размер файла не указан (`file.size` равен `None`), запрос отклоняется с кодом ошибки `400 Bad Request`. Это предотвращает загрузку файлов произвольного размера в память и защищает от атак типа "отказ в обслуживании".
* **Защита от zip-бомб:** При обработке архивных форматов применяется ограничение на размер распакованного содержимого (100 МБ) для предотвращения атак типа "zip-бомба".
* **Контроль временных файлов:** Все временные файлы и папки, создаваемые во время обработки, должны автоматически удаляться после завершения операции с использованием контекстных менеджеров Python. Система должна гарантировать освобождение дискового пространства даже при возникновении исключений.

**5.4. Среда развертывания:**
* Сервис должен поставляться в виде **Docker-контейнера**.

**5.5. Логирование:**
* Сервис должен вести структурированные логи (запросы, ошибки с traceback).

**5.6. Конфигурация и Воспроизводимость:**
* **Переменные окружения:** Ключевые параметры должны задаваться через переменные окружения для гибкой настройки без пересборки образа.
    * `API_PORT` (по умолчанию: 7555)
    * `OCR_LANGUAGES` (по умолчанию: rus+eng)
    * `PROCESSING_TIMEOUT_SECONDS` (по умолчанию: 300)
    * `WORKERS` (по умолчанию: 1 для разработки, рекомендуется 2 * (количество ядер CPU) + 1 для продакшена)
    * `MAX_ARCHIVE_SIZE` (по умолчанию: 20971520 - 20 МБ)
    * `MAX_EXTRACTED_SIZE` (по умолчанию: 104857600 - 100 МБ)
    * `MAX_ARCHIVE_NESTING` (по умолчанию: 3)
* **Фиксация зависимостей:** Проект должен содержать файл `requirements.txt` с зафиксированными версиями всех Python-библиотек для обеспечения воспроизводимости сборок.

### 6. Рекомендуемый технологический стек

* **Язык:** Python 3.10+
* **Веб-фреймворк:** FastAPI
* **Веб-сервер:** Uvicorn

### 7. Управление проектом и тестирование

**7.1. Makefile**
```makefile
# Makefile для управления жизненным циклом API
IMAGE_NAME := text-extraction-api
TAG := latest

.PHONY: help build dev prod stop logs test clean

help:
  @echo "Команды: build, dev, prod, stop, logs, test, clean"

build:
  docker build -t $(IMAGE_NAME):$(TAG) .

dev: build
  docker-compose -f docker-compose.yml up

prod: build
  docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

stop:
  docker-compose -f docker-compose.yml -f docker-compose.prod.yml down

logs:
  docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f

test:
  @echo "Запуск тестов конвертации..."
  @./run_tests.sh

clean:
  docker-compose -f docker-compose.yml -f docker-compose.prod.yml down --volumes --remove-orphans
```

**7.2. docker-compose.yml (для разработки)**
```yaml
version: '3.8'
services:
  api:
    image: text-extraction-api:latest
    build: .
    command: uvicorn app.main:app --host 0.0.0.0 --port ${API_PORT:-7555} --workers ${WORKERS:-1} --reload
    ports:
      - "${API_PORT:-7555}:${API_PORT:-7555}"
    volumes:
      - ./app:/code/app
      - ./tests:/code/tests
    env_file:
      - .env
```

**7.3. docker-compose.prod.yml (для продакшена)**
```yaml
version: '3.8'
services:
  api:
    volumes: []
    command: uvicorn app.main:app --host 0.0.0.0 --port ${API_PORT:-7555} --workers ${WORKERS:-9}
    restart: always
    env_file:
      - .env
```

**7.4. Тестирование (`make test`)**

**7.4.1. Фреймворк тестирования**
* **Основной фреймворк:** pytest + pytest-asyncio для тестирования асинхронного кода FastAPI
* **Покрытие кода:** pytest-cov для измерения покрытия с минимальным порогом 70%
* **HTTP клиент:** httpx для тестирования API эндпоинтов (официально рекомендуется для FastAPI)
* **Моки и фикстуры:** pytest-mock для создания заглушек внешних зависимостей

**7.4.2. Структура тестов**
```
tests/
├── conftest.py          # Общие фикстуры и настройки
├── test_main.py         # Integration тесты API эндпоинтов
├── test_extractors.py   # Unit тесты логики извлечения текста
├── test_utils.py        # Unit тесты утилитарных функций
├── test_config.py       # Unit тесты конфигурации
├── test_integration.py  # Integration тесты с реальными файлами
└── pytest.ini          # Конфигурация pytest
```

**7.4.3. Типы тестов**
* **Unit тесты** (`make test-unit`): тестирование отдельных функций и методов в изоляции
* **Integration тесты** (`make test-integration`): тестирование взаимодействия компонентов и API эндпоинтов
* **Тесты с реальными файлами**: использование файлов из папки `tests/` для проверки функциональности
* **Тесты производительности**: проверка времени ответа и обработки одновременных запросов

**7.4.4. Покрытие кода**
* **Минимальный порог покрытия:** 70%
* **Отчеты покрытия:**
  - Терминальный отчет с указанием непокрытых строк
  - HTML отчет в папке `coverage_html/`
  - XML отчет для CI/CD систем
* **Команда просмотра:** `make test-coverage` для открытия HTML отчета в браузере

**7.4.5. Команды тестирования**
* `make test` - полное тестирование с покрытием кода
* `make test-unit` - только unit тесты
* `make test-integration` - только integration тесты
* `make test-coverage` - просмотр отчета покрытия
* `make test-legacy` - legacy функциональные тесты через `run_tests.sh`

**7.4.6. Legacy функциональное тестирование (`make test-legacy`)**
* В корне проекта сохранен скрипт `run_tests.sh` для итерации по файлам в папке `tests` и проверки их конвертации через запущенный в Docker сервис.
* **Перед началом тестирования** скрипт удаляет все предыдущие результаты тестов (файлы `tests/*.ok.txt` и `tests/*.err.txt`) для обеспечения "чистого" запуска.
* Если файл успешно преобразован, создается файл `ИМЯ_ФАЙЛА.ok.txt` с извлеченным текстом.
* Если произошла ошибка, создается файл `ИМЯ_ФАЙЛА.err.txt` с текстом ошибки.
* Скрипт игнорирует служебные файлы (например, `supported_formats.json`, `*.ok.txt`, `*.err.txt`) при поиске файлов для тестирования.

**7.5. Файл `.gitignore`**
В `.gitignore` должны быть добавлены результаты тестов:
```gitignore
# Результаты тестов
tests/*.ok.txt
tests/*.err.txt
