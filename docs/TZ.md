# Техническое задание: API для извлечения текста для RAG

**Версия:** 1.5
**Дата:** 05.07.2025
**Заказчик:** ООО "СОФТОНИТ"

---

### 1. Общие сведения

**1.1. Назначение системы:**
Разработка серверного API (далее — Сервис) для комплексного извлечения текстового содержимого из файлов различных форматов.

**1.2. Конечная цель и контекст использования:**
Извлеченный текст будет использоваться для создания векторных представлений (embeddings) с последующей загрузкой в векторную базу данных в рамках системы **RAG (Retrieval-Augmented Generation)**.
Ключевыми приоритетами являются **полнота, точность и структурированность** извлекаемых данных для обеспечения максимального качества работы RAG-модели.

### 2. Термины и определения

* **RAG (Retrieval-Augmented Generation):** Архитектура, объединяющая языковые модели с внешними базами знаний для повышения точности и релевантности ответов.
* **OCR (Optical Character Recognition):** Оптическое распознавание символов; технология преобразования изображений с текстом в машиночитаемый текст.
* **API (Application Programming Interface):** Программный интерфейс приложения.

### 3. Функциональные требования

**3.1. Общая стратегия извлечения:**
Сервис должен извлекать **весь доступный текстовый контент** из файла, объединяя данные из разных источников (текстовый слой, OCR, метаданные) в единый вывод.

**3.2. Обработка PDF-документов:**
1. Извлекается основной текстовый слой документа.
2. Из документа извлекаются все встроенные изображения.
3. К каждому изображению применяется процедура OCR (согласно п. 3.4).
4. Текст, полученный после OCR, объединяется с текстом из основного слоя.  Рекомендуемая структура итогового текста для сохранения семантической связности:
```
[Текст со страницы 1]
--- OCR ---
[Текст с первого изображения на странице 1]
[Текст со второго изображения на странице 1]
---
[Текст со страницы 2]
...
```

**3.3. Обработка документов (`.docx`, `.odt`, `.rtf`) и презентаций (`.pptx`, `.ppt`):**
* Извлекается текст из основного тела документа, а также из **колонтитулов, сносок, комментариев и заметок спикера**.
* К встроенным изображениям применяется процедура OCR.

**3.4. Обработка изображений и OCR:**
* **Поддерживаемые форматы:** `.jpg`, `.jpeg`, `.png`, `.tiff`, `.tif`, `.bmp`, `.gif`.
* **Языки:** Сервис должен по умолчанию производить распознавание одновременно на **русском и английском языках**.
* **Отсутствие текста:** Если OCR-движок не обнаруживает текст на изображении, оно игнорируется.

**3.5. Обработка таблиц (`.xls`, `.xlsx`, `.csv`, `.ods`):**
* Данные из таблиц должны быть преобразованы в формат **CSV (Comma-Separated Values)**.
* Каждый лист таблицы конвертируется в отдельный блок, разделенный маркером.

**3.6. Обработка прочих форматов (`.txt`, `.html`, `.md`, `.json` и др.):**
* Извлекается текстовое содержимое. Из форматов с разметкой разметка удаляется.

### 4. Требования к API

**4.0. Базовый URL:**
* Для локальной разработки Сервис должен быть доступен по адресу `http://localhost:7555`.

**4.1. Эндпоинт `GET /` — Информация о API**
* **Ответ (`HTTP 200 OK`):**
```json
{
  "api_name": "Text Extraction API for RAG",
  "version": "1.5",
  "contact": "ООО 'СОФТОНИТ'"
}
```

**4.2. Эндпоинт `GET /health` — Проверка состояния**
* **Ответ (`HTTP 200 OK`):**
```json
{
  "status": "ok"
}
```

**4.3. Эндпоинт `GET /v1/supported-formats/` — Поддерживаемые форматы**
* **Ответ (`HTTP 200 OK`):**
```json
{
  "images_ocr": ["jpg", "jpeg", "png", "tiff", "tif", "bmp", "gif"],
  "documents": ["doc", "docx", "pdf", "rtf", "odt"],
  "spreadsheets": ["csv", "xls", "xlsx", "ods"],
  "presentations": ["pptx", "ppt"],
  "other": ["txt", "html", "htm", "md", "markdown", "json", "epub", "eml", "msg"]
}
```

**4.4. Эндпоинт `POST /v1/extract/` — Извлечение текста**
* **Метод:** `POST`.
* **Тело запроса:** `multipart/form-data` с полем `file`.
* **Успешный ответ (`HTTP 200 OK`):**
```json
{
  "status": "success",
  "filename": "invoice.pdf",
  "text": "Полностью извлеченный и скомбинированный текст..."
}
```
* **Ответы с ошибкой:**
    * **`413 Payload Too Large`**: Файл превышает максимальный размер.
    * **`415 Unsupported Media Type`**: Формат файла не поддерживается.
    * **`422 Unprocessable Entity`**: Файл поврежден, пуст или защищен паролем.
    * **`504 Gateway Timeout`**: Обработка файла превысила установленный лимит времени.
    
    Пример ответа с ошибкой:
```json
{
  "status": "error",
  "filename": "broken.docx",
  "message": "File is corrupted or format is not supported."
}
```

**4.5. Документация API (Swagger UI):**
* Сервис должен предоставлять интерактивную документацию API, автоматически генерируемую фреймворком FastAPI.
* Интерактивная документация должна быть доступна по адресу `http://localhost:7555/docs`.

### 5. Нефункциональные требования

**5.1. Производительность:**
* **Максимальный размер файла:** **20 МБ**.
* **Таймаут обработки:** **300 секунд (5 минут)**. При превышении — возврат ошибки `504 Gateway Timeout`.

**5.2. Безопасность:**
* Аутентификация не требуется (предназначено для внутренней сети).

**5.3. Среда развертывания:**
* Сервис должен поставляться в виде **Docker-контейнера**.

**5.4. Логирование:**
* Сервис должен вести структурированные логи (запросы, ошибки с traceback).

**5.5. Конфигурация и Воспроизводимость:**
* **Переменные окружения:** Ключевые параметры должны задаваться через переменные окружения для гибкой настройки без пересборки образа.
    * `API_PORT` (по умолчанию: 7555)
    * `OCR_LANGUAGES` (по умолчанию: rus+eng)
    * `PROCESSING_TIMEOUT_SECONDS` (по умолчанию: 300)
* **Фиксация зависимостей:** Проект должен содержать файл `requirements.txt` с зафиксированными версиями всех Python-библиотек для обеспечения воспроизводимости сборок.

### 6. Рекомендуемый технологический стек

* **Язык:** Python 3.10+
* **Веб-фреймворк:** FastAPI
* **Веб-сервер:** Uvicorn

### 7. Управление проектом и тестирование

**7.1. Makefile**
```makefile
# Makefile для управления жизненным циклом API
IMAGE_NAME := text-extraction-api
TAG := latest

.PHONY: help build dev prod stop logs test clean

help:
  @echo "Команды: build, dev, prod, stop, logs, test, clean"

build:
  docker build -t $(IMAGE_NAME):$(TAG) .

dev: build
  docker-compose -f docker-compose.yml up

prod: build
  docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

stop:
  docker-compose -f docker-compose.yml -f docker-compose.prod.yml down

logs:
  docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f

test:
  @echo "Запуск тестов конвертации..."
  @./run_tests.sh

clean:
  docker-compose -f docker-compose.yml -f docker-compose.prod.yml down --volumes --remove-orphans
```

**7.2. docker-compose.yml (для разработки)**
```yaml
version: '3.8'
services:
  api:
    image: text-extraction-api:latest
    build: .
    command: uvicorn app.main:app --host 0.0.0.0 --port ${API_PORT:-7555} --reload
    ports:
      - "${API_PORT:-7555}:${API_PORT:-7555}"
    volumes:
      - ./app:/code/app
      - ./tests:/code/tests
    env_file:
      - .env
```

**7.3. docker-compose.prod.yml (для продакшена)**
```yaml
version: '3.8'
services:
  api:
    volumes: []
    command: uvicorn app.main:app --host 0.0.0.0 --port ${API_PORT:-7555}
    restart: always
    env_file:
      - .env
```

**7.4. Тестирование (`make test`)**
* В корне проекта должен быть скрипт `run_tests.sh` для итерации по файлам в папке `tests` и проверки их конвертации через запущенный в Docker сервис.
* **Перед началом тестирования** скрипт должен удалить все предыдущие результаты тестов (файлы `tests/*.ok.txt` и `tests/*.err.txt`) для обеспечения "чистого" запуска.
* Если файл успешно преобразован, создается файл `ИМЯ_ФАЙЛА.ok.txt` с извлеченным текстом.
* Если произошла ошибка, создается файл `ИМЯ_ФАЙЛА.err.txt` с текстом ошибки.
* Скрипт должен игнорировать служебные файлы (например, `supported_formats.json`, `*.ok.txt`, `*.err.txt`) при поиске файлов для тестирования.

**7.5. Файл `.gitignore`**
В `.gitignore` должны быть добавлены результаты тестов:
```gitignore
# Результаты тестов
tests/*.ok.txt
tests/*.err.txt
