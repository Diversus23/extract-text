# Changelog

Все важные изменения в этом проекте будут документированы в этом файле.

## [1.8.0] - 2025-07-06

### Добавлено
- **Полная поддержка обработки архивов**
  - Безопасная обработка архивов: ZIP, RAR, 7Z, TAR, GZ, BZ2, XZ, TGZ, TBZ2, TXZ
  - Извлечение и обработка всех файлов из архивов
  - Рекурсивная обработка вложенных архивов с контролем глубины (до 3 уровней)
  - Защита от zip-бомб: ограничение размера распакованного содержимого (100 МБ)
  - Защита от path traversal атак с санитизацией имен файлов
  - Выполнение распаковки в отдельном процессе с таймаутом
  - Фильтрация системных файлов (.DS_Store, Thumbs.db, .git/ и др.)

### Изменено
- **Обновлена версия API с 1.7.3 до 1.8.0**
- **Изменен формат ответа API POST /v1/extract/**
  - Теперь возвращается массив файлов с информацией о каждом файле
  - Для обычных файлов - массив с одним элементом
  - Для архивов - массив со всеми обработанными файлами из архива
  - Каждый элемент содержит: filename, path, size, type, text

### Улучшено
- **Безопасность системы:**
  - Контроль размера архивов и распакованного содержимого
  - Санитизация имен файлов из архивов
  - Защита от атак через вложенные архивы
  - Автоматическое удаление временных файлов с использованием контекстных менеджеров
- **Архитектура:**
  - Модульная обработка различных типов архивов
  - Унифицированный интерфейс для всех типов файлов
  - Улучшенная обработка ошибок и логирование

### Техническое
- Добавлены новые зависимости: `rarfile==4.1`, `py7zr==0.20.8`
- Новые переменные окружения:
  - `MAX_ARCHIVE_SIZE` (по умолчанию: 20 МБ)
  - `MAX_EXTRACTED_SIZE` (по умолчанию: 100 МБ)
  - `MAX_ARCHIVE_NESTING` (по умолчанию: 3)
- Добавлены методы в класс `TextExtractor`:
  - `_extract_from_archive()` - основной метод обработки архивов
  - `_extract_zip_files()` - обработка ZIP-архивов
  - `_extract_tar_files()` - обработка TAR-архивов
  - `_extract_rar_files()` - обработка RAR-архивов
  - `_extract_7z_files()` - обработка 7Z-архивов
  - `_process_extracted_file()` - обработка извлеченных файлов
  - `_sanitize_archive_filename()` - санитизация имен файлов
  - `_is_system_file()` - проверка системных файлов
- Обновлена техническая документация в `TZ.md` с полным описанием обработки архивов

## [1.7.3] - 2025-07-06

### Добавлено
- **Настройка worker-процессов uvicorn**
  - Новая переменная окружения `WORKERS` для управления количеством worker-процессов
  - Рекомендуется использовать формулу: 2 * (количество ядер CPU) + 1 для продакшена
  - По умолчанию: 1 worker для разработки, 9 workers для продакшена
  - Документация по настройке производительности в техническом задании

### Изменено
- **Обновлена версия API с 1.7.2 до 1.7.3**
- Команды uvicorn в docker-compose.yml и docker-compose.prod.yml теперь используют переменную `WORKERS`
- Добавлена секция "Многопроцессорность" в нефункциональные требования
- Обновлен env_example с комментариями по настройке workers

### Улучшено
- **Производительность системы:**
  - Возможность полного использования всех ядер CPU
  - Повышенная пропускная способность для обработки одновременных запросов
  - Гибкая настройка производительности через переменные окружения

### Техническое
- Добавлена настройка `WORKERS` в класс `Settings` в `config.py`
- Обновлены docker-compose файлы для поддержки переменной `WORKERS`
- Обновлена техническая документация в `TZ.md` с разделом производительности

## [1.7.2] - 2025-07-06

### Добавлено
- **Улучшенная безопасность API**
  - Санитизация имен файлов для предотвращения path traversal атак
  - Проверка соответствия расширения файла его содержимому (MIME-типу)
  - Защита от DoS-атак: обязательная проверка наличия заголовка Content-Length
  - Новая функция `sanitize_filename()` для очистки имен файлов
  - Новая функция `validate_file_type()` для проверки типов файлов

### Изменено
- **Обновлена версия API с 1.7.1 до 1.7.2**
- Добавлена новая ошибка `400 Bad Request` для случаев отсутствия Content-Length
- Расширены сообщения об ошибках `415 Unsupported Media Type`
- Улучшена обработка ошибок в основном API

### Улучшено
- **Безопасность системы:**
  - Предотвращение загрузки файлов с подделанными расширениями
  - Защита от атак через имена файлов
  - Защита от отказа в обслуживании через большие файлы без Content-Length
- **Логирование:**
  - Более детальные сообщения безопасности
  - Предупреждения о потенциальных угрозах

### Техническое
- Добавлены зависимости: `python-magic` для определения MIME-типов
- Добавлен метод `sanitize_filename()` в модуль `utils.py`
- Добавлен метод `validate_file_type()` в модуль `utils.py`
- Обновлена обработка исключений в основном API
- Обновлена техническая документация в `TZ.md` с разделом безопасности

## [1.7.1] - 2025-07-05

### Добавлено
- **Обработка архивов**
  - Поддержка обнаружения архивных форматов: `.zip`, `.rar`, `.7z`, `.tar`, `.gz`, `.bz2`, `.xz`, `.tgz`, `.tbz2`, `.txz`, `.tar.gz`, `.tar.bz2`, `.tar.xz`, `.lzma`, `.z`, `.cab`, `.iso`, `.dmg`, `.deb`, `.rpm`, `.apk`, `.msi`, `.pkg`, `.exe`, `.bin`, `.run`, `.app`, `.jar`, `.war`, `.ear`
  - При обнаружении архива API возвращает ошибку 415 с требованием распаковать архив и отправить каждый файл отдельно
  - Добавлена функция `is_archive_format()` для определения архивных файлов
  - Улучшенная обработка составных расширений (tar.gz, tar.bz2, tar.xz)

### Изменено
- Обновлена версия API с 1.7 до 1.7.1
- Добавлена новая категория `archives` в список поддерживаемых форматов
- Обновлены сообщения об ошибках на русском языке
- Улучшена обработка ошибок ValueError в основном API

### Улучшено
- Безопасность системы: предотвращение обработки потенциально опасных архивов
- Контроль пользователя над содержимым архивов
- Более информативные сообщения об ошибках

### Техническое
- Добавлен новый метод `is_archive_format()` в модуль `utils.py`
- Расширен метод `get_file_extension()` для поддержки составных расширений
- Обновлена обработка исключений в основном API
- Обновлена техническая документация в `TZ.md`

## [1.7.0] - 2025-07-05

### Добавлено
- **Поддержка исходного кода различных языков программирования**
  - Python (`.py`, `.pyx`, `.pyi`, `.pyw`)
  - JavaScript/TypeScript (`.js`, `.jsx`, `.ts`, `.tsx`, `.mjs`, `.cjs`)
  - Java (`.java`, `.jav`)
  - C/C++ (`.c`, `.cpp`, `.cxx`, `.cc`, `.c++`, `.h`, `.hpp`, `.hxx`, `.h++`)
  - C# (`.cs`, `.csx`)
  - PHP (`.php`, `.php3`, `.php4`, `.php5`, `.phtml`)
  - Ruby (`.rb`, `.rbw`, `.rake`, `.gemspec`)
  - Go (`.go`, `.mod`, `.sum`)
  - Rust (`.rs`, `.rlib`)
  - Swift (`.swift`)
  - Kotlin (`.kt`, `.kts`)
  - Scala (`.scala`, `.sc`)
  - R (`.r`, `.R`, `.rmd`, `.Rmd`)
  - SQL (`.sql`, `.ddl`, `.dml`)
  - Shell (`.sh`, `.bash`, `.zsh`, `.fish`, `.ksh`, `.csh`, `.tcsh`)
  - PowerShell (`.ps1`, `.psm1`, `.psd1`)
  - Perl (`.pl`, `.pm`, `.pod`, `.t`)
  - Lua (`.lua`)
  - **1C:Enterprise (`.bsl`)**
  - **OneScript (`.os`)**
  - Конфигурационные файлы (`.ini`, `.cfg`, `.conf`, `.config`, `.toml`, `.properties`)
  - Веб-технологии (`.css`, `.scss`, `.sass`, `.less`, `.styl`)
  - Разметка и документация (`.tex`, `.latex`, `.rst`, `.adoc`, `.asciidoc`)
  - Специальные форматы (`.jsonl`, `.ndjson`, `.jsonc`, `.dockerfile`, `.containerfile`, `.makefile`, `.mk`, `.mak`, `.gitignore`, `.gitattributes`, `.gitmodules`)

### Изменено
- Обновлена версия API с 1.6 до 1.7
- Расширен список поддерживаемых форматов в конфигурации
- Добавлена новая категория `source_code` в список поддерживаемых форматов
- Обновлено техническое задание с описанием обработки исходного кода

### Улучшено
- Файлы исходного кода теперь обрабатываются с сохранением структуры и форматирования
- Добавляется информативный заголовок с указанием языка программирования, имени файла и количества строк
- Улучшен контекст для использования в RAG-системах

### Техническое
- Добавлен новый метод `_extract_from_source_code` в класс `TextExtractor`
- Реализована автоматическая идентификация языка программирования по расширению файла
- Поддержка множественных кодировок для файлов исходного кода (UTF-8, CP1251, Latin-1)
- Добавлены тестовые файлы для проверки функциональности:
  - `test.py` - тестовый Python файл
  - `test.js` - тестовый JavaScript файл
  - `test.java` - тестовый Java файл
  - `config.toml` - тестовый конфигурационный файл
  - `test.sql` - тестовый SQL файл

## [1.6.0] - 2025-05-07

### Добавлено
- Поддержка .ppt файлов (презентации PowerPoint)
- Поддержка .msg файлов (письма Outlook)
- Улучшенная поддержка .epub файлов
- Защита от zip-бомб

### Исправлено
- Проблема с обработкой .doc файлов (HTTP 422 ошибка)
- Проблема с OCR для изображений в PDF файлах
- Проблемы с правами доступа в Docker контейнере

### Улучшено
- Двухуровневый подход к извлечению текста из изображений в PDF
- Лучшая обработка поврежденных файлов
- Улучшенная система логирования
